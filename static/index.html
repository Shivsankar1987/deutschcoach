<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DeutschCoach</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 16px; }
    button { font-size: 20px; padding: 14px 16px; width: 100%; }
    .box { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    .label { font-weight: 600; margin-bottom: 6px; }
  </style>
</head>
<body>
  <h2>DeutschCoach (Ã–sterreich)</h2>
  <button id="talkBtn">ğŸ¤ Hold to talk</button>
  <button id="resetBtn" style="margin-top:10px;">
    ğŸ”„ Reset Conversation
  </button>
  <div style="margin-bottom:12px;">
    <label class="label">Mode:</label>
    <select id="mode" style="font-size:18px; width:100%; padding:10px;">
      <option value="chat">ğŸ—£ Chat</option>
      <option value="correct">âœï¸ Correct my sentence</option>
      <option value="roleplay">ğŸ­ Roleplay (BÃ¤ckerei/Schule)</option>
      <option value="quiz">ğŸ§  Mini quiz</option>
    </select>
  </div>

  <div class="box">
    <div class="label">You said</div>
    <div id="transcript">â€”</div>
  </div>

  <div class="box">
    <div class="label">Coach</div>
    <div id="reply">â€”</div>
  </div>

  <audio id="player" controls style="width:100%; margin-top: 12px;"></audio>

  <script>
    const talkBtn = document.getElementById("talkBtn");
    const transcriptEl = document.getElementById("transcript");
    const replyEl = document.getElementById("reply");
    const player = document.getElementById("player");
    const modeEl = document.getElementById("mode");
    const resetBtn = document.getElementById("resetBtn");

    let sessionId = localStorage.getItem("sessionId") || "";

    let mediaRecorder, chunks = [];

async function startRecording() {
  transcriptEl.textContent = "Listeningâ€¦";
  replyEl.textContent = "â€”";
  chunks = [];

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  // Pick the best supported mimeType for this browser (iPad Safari can be picky)
  const candidates = [
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/mp4",          // sometimes works better on iOS
    "audio/aac"
  ];

  let chosen = "";
  for (const t of candidates) {
    if (MediaRecorder.isTypeSupported(t)) { chosen = t; break; }
  }

  mediaRecorder = chosen ? new MediaRecorder(stream, { mimeType: chosen }) : new MediaRecorder(stream);

  mediaRecorder.ondataavailable = (e) => {
    if (e.data && e.data.size > 0) chunks.push(e.data);
  };

  mediaRecorder.start();
}


    async function stopRecording() {
      return new Promise((resolve) => {
        mediaRecorder.onstop = () => resolve();
        mediaRecorder.stop();
      });
    }


  async function sendToServer(blob) {
    transcriptEl.textContent = "Sendingâ€¦";

    const fd = new FormData();
    const mime = blob.type || "";
    let ext = "webm";
    if (mime.includes("mp4")) ext = "mp4";
    else if (mime.includes("ogg")) ext = "ogg";
    else if (mime.includes("wav")) ext = "wav";
    else if (mime.includes("mpeg")) ext = "mp3";

    fd.append("audio", blob, `speech.${ext}`);
    console.log("Sending audio:", blob.type, blob.size);

    fd.append("mode", modeEl.value);
    fd.append("session_id", sessionId);
    // timeout after 45s so UI doesnâ€™t hang forever
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 45000);

    try {
      const res = await fetch("/talk", {
        method: "POST",
        body: fd,
        signal: controller.signal
      });

      if (!res.ok) {
        const text = await res.text();
        transcriptEl.textContent = `Server error (${res.status})`;
        replyEl.textContent = text.slice(0, 400);
        return;
      }

      const data = await res.json();
      if (data.session_id) {
               sessionId = data.session_id;
               localStorage.setItem("sessionId", sessionId);
               }
      transcriptEl.textContent = data.transcript || "â€”";
      replyEl.textContent = data.reply || "â€”";

      const bytes = Uint8Array.from(atob(data.audio_b64), c => c.charCodeAt(0));
      const mp3Blob = new Blob([bytes], { type: "audio/mpeg" });
      player.src = URL.createObjectURL(mp3Blob);
      await player.play();

    } catch (err) {
      transcriptEl.textContent = "Failed to send (see error)";
      replyEl.textContent =
        err.name === "AbortError"
          ? "Timed out waiting for the server. Check your server terminal for errors."
          : (err.message || String(err));
    } finally {
      clearTimeout(t);
    }
  }



    talkBtn.addEventListener("touchstart", async (e) => {
      e.preventDefault();
      await startRecording();
      talkBtn.textContent = "âºï¸ Recordingâ€¦ release to send";
    });

    talkBtn.addEventListener("touchend", async (e) => {
      e.preventDefault();
      await stopRecording();
      talkBtn.textContent = "ğŸ¤ Hold to talk";
      if (!chunks.length) {
            transcriptEl.textContent = "No audio captured. Try again.";
      return;
     }
     const blob = new Blob(chunks, { type: mediaRecorder.mimeType || chunks[0].type || "audio/webm" });
      await sendToServer(blob);
    });

    // Also support mouse for laptop testing
    talkBtn.addEventListener("mousedown", async () => {
      await startRecording();
      talkBtn.textContent = "âºï¸ Recordingâ€¦ release to send";
    });
    talkBtn.addEventListener("mouseup", async () => {
      await stopRecording();
      talkBtn.textContent = "ğŸ¤ Hold to talk";
      if (!chunks.length) {
          transcriptEl.textContent = "No audio captured. Try again.";
      return;
      }
      const blob = new Blob(chunks, { type: mediaRecorder.mimeType || chunks[0].type || "audio/webm" });

      await sendToServer(blob);
    });
    
    resetBtn.addEventListener("click", async () => {

    if (!sessionId) {
        replyEl.textContent = "No active session to reset.";
        return;
    }

    try {
        await fetch("/reset", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ session_id: sessionId })
        });
    } catch (e) {
        console.error("Reset error:", e);
    }

    // Clear browser session
    sessionId = "";
    localStorage.removeItem("sessionId");

    // Clear UI
    transcriptEl.textContent = "â€”";
    replyEl.textContent = "Conversation reset. Sag: Hallo ğŸ™‚";
    player.src = "";
});

  </script>
</body>
</html>
